# Гипотезы по улучшению стратегии с использованием MAD

## Ключевая идея

Заменить статические пороги и процентили в условиях генерации сигнала на **адаптивные, робастные статистические пороги**. Это позволит стратегии самонастраиваться под текущую рыночную волатильность и режим, а также сделает ее менее чувствительной к аномальным выбросам (шуму).

Инструмент: **MAD (Median Absolute Deviation)** — Медианное абсолютное отклонение.

---

### Гипотеза 1: Адаптивный порог для `highNatr`

*   **Текущая логика:** `NATR > natr_min` (например, `NATR > 0.35`).
*   **Проблема:** Порог фиксированный. Стратегия не адаптируется к изменению общей волатильности рынка. В периоды затишья она не найдет сигналов, а в периоды высокой волатильности будет "спамить" ложными сигналами.
*   **Предлагаемая логика:** `NATR > rolling_median(NATR, N) + K * rolling_mad(NATR, N)`.
    *   `N` — период для расчета медианы и MAD (например, 50-100 баров).
    *   `K` — коэффициент чувствительности (например, 2.0-3.0).
*   **Эффект:** Сигнал генерируется, когда волатильность **статистически аномально высокая** относительно своего же недавнего поведения. Порог становится плавающим.

---

### Гипотеза 2: Робастное условие для `lowVol`

*   **Текущая логика:** `volume <= percentile(volume, N, P)`.
*   **Проблема:** Процентиль может быть неустойчив к нескольким случайным всплескам объема внутри окна расчета.
*   **Предлагаемая логика:** `volume < rolling_median(volume, N) - K * rolling_mad(volume, N)`.
*   **Эффект:** Сигнал генерируется, когда объем **статистически аномально низкий** по сравнению с его нормальным (медианным) значением. Это более надежный способ идентификации "затишья" перед бурей.

---

### Гипотеза 3: Робастное условие для `narrowRng`

*   **Текущая логика:** `range <= percentile(range, N, P)`.
*   **Проблема:** Аналогична `lowVol`.
*   **Предлагаемая логика:** `range < rolling_median(range, N) - K * rolling_mad(range, N)`.
*   **Эффект:** Сигнал генерируется, когда диапазон свечи **статистически аномально узкий**. Это более точно определяет фазу консолидации.

---

### Гипотеза 4: Робастный сигнал по `prints_ratio`

*   **Текущая логика:** `ratio > prints_threshold_ratio` (например, `ratio > 1.5`).
*   **Проблема:** Фиксированный порог не учитывает, что "нормальное" соотношение принтов может меняться со временем и для разных инструментов.
*   **Предлагаемая логика:** Использовать робастный Z-score.
    *   `robust_z_score = (ratio - rolling_median(ratio, N)) / rolling_mad(ratio, N)`
    *   **Новое правило:** `robust_z_score > K` (например, `K > 2.5`).
*   **Эффект:** Сигнал генерируется, когда перевес покупателей (или продавцов) **статистически аномален относительно недавнего поведения самого `ratio`**. Это позволяет находить действительно необычную активность, а не просто превышение произвольного числа.
