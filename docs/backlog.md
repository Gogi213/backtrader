# Backlog и Анализ Архитектуры Проекта

## Анализ: Два разных бектестера (CLI vs GUI)

### Дата анализа: 2025-10-05

### Текущая ситуация

В проекте действительно существуют два разных бектестера:
1. **CLI версия** - через `src/data/backtest_engine.py` и `optimize.py`
2. **GUI версия** - через `src/gui/main_window.py` и `src/gui/config_models.py`

### Сравнение реализаций

#### CLI версия (`src/data/backtest_engine.py`)
- **Основная функция**: `run_vectorized_klines_backtest()`
- **Входная точка**: `main()` функция с argparse
- **Особенности**:
  - Прямая работа с numpy массивами
  - Поддержка различных стратегий через StrategyRegistry
  - Консольный вывод результатов
  - Параметры через CLI аргументы
  - Опциональное сохранение результатов в файл

#### GUI версия (`src/gui/config_models.py`)
- **Основная функция**: `BacktestWorker` (QThread)
- **Входная точка**: GUI интерфейс через `main_window.py`
- **Особенности**:
  - Использует ту же функцию `run_vectorized_klines_backtest()`
  - Обёртка в QThread для асинхронного выполнения
  - Сигналы для прогресса и результатов
  - Визуализация результатов в интерфейсе
  - Ограничение на количество klines для производительности GUI

### Выявленные проблемы

1. **Дублирование кода**:
   - Обе версии используют один и тот же `run_vectorized_klines_backtest()`
   - Но имеют разную обработку параметров и результатов
   - Разная логика валидации входных данных

2. **Несогласованность параметров**:
   - CLI версия использует `max_klines` параметр
   - GUI версия использует `max_ticks` с разными значениями по умолчанию
   - Разная обработка параметров стратегий

3. **Разная обработка ошибок**:
   - CLI версия выводит ошибки в консоль
   - GUI версия использует сигналы `error_signal`

4. **Избыточность в оптимизации**:
   - Отдельный `optimize.py` для CLI
   - Отдельный `OptimizationTab` для GUI
   - Оба используют `FastStrategyOptimizer` но с разной обвязкой

### Рекомендации по унификации

#### 1. Создать единый BacktestManager
```python
class BacktestManager:
    def __init__(self):
        self.config = BacktestConfig()
        self.results_handler = ResultsHandler()
    
    def run_backtest(self, config: BacktestConfig) -> BacktestResults:
        # Единая логика выполнения бектеста
        pass
    
    def validate_config(self, config: BacktestConfig) -> bool:
        # Единая валидация параметров
        pass
```

#### 2. Унифицировать обработку параметров
- Создать единый класс конфигурации для всех режимов
- Использовать одинаковые имена параметров
- Единая валидация параметров стратегий

#### 3. Создать абстрактный интерфейс результатов
```python
class BacktestResults:
    def to_dict(self) -> dict:
        pass
    
    def to_console_output(self) -> str:
        pass
    
    def to_gui_format(self) -> dict:
        pass
```

#### 4. Унифицировать оптимизацию
- Создать единый OptimizationManager
- Разделить логику оптимизации и отображения результатов
- Использовать один и тот же FastStrategyOptimizer

### План рефакторинга

#### Этап 1: Создание unified core
1. Создать `src/core/backtest_manager.py`
2. Создать `src/core/backtest_config.py`
3. Создать `src/core/backtest_results.py`
4. Создать `src/core/optimization_manager.py`

#### Этап 2: Рефакторинг CLI
1. Обновить `src/data/backtest_engine.py` для использования BacktestManager
2. Обновить `optimize.py` для использования OptimizationManager
3. Сохранить обратную совместимость CLI интерфейса

#### Этап 3: Рефакторинг GUI
1. Обновить `src/gui/config_models.py` для использования BacktestManager
2. Обновить `src/gui/tabs/tab_optimization.py` для использования OptimizationManager
3. Упростить логику в GUI компонентах

#### Этап 4: Тестирование и оптимизация
1. Написать тесты для unified core
2. Проверить производительность
3. Удалить дублированный код

### Преимущества унификации

1. **Уменьшение дублирования кода** на ~40%
2. **Единая логика** обработки параметров и результатов
3. **Упрощение поддержки** и добавления новых функций
4. **Согласованность** между CLI и GUI версиями
5. **Улучшенная тестируемость** core компонентов

### Риски

1. **Регрессии** при рефакторинге
2. **Изменение API** может сломать существующий код
3. **Временные затраты** на рефакторинг

### Рекомендуемый подход

1. **Постепенный рефакторинг** с сохранением обратной совместимости
2. **Тестирование на каждом этапе**
3. **Использование адаптеров** для плавного перехода
4. **Документирование изменений** в API

## План спринтов для унификации бектестера

### Sprint 1: Foundation (1 неделя)

**Цель:** Создать основу для унифицированного бектестера

**Задачи:**
- [ ] Создать `src/core/` директорию
- [ ] Реализовать `src/core/backtest_config.py`:
  ```python
  @dataclass
  class BacktestConfig:
      strategy_name: str
      strategy_params: Dict[str, Any]
      symbol: str = 'BTCUSDT'
      initial_capital: float = 10000.0
      commission_pct: float = 0.05
      max_klines: Optional[int] = None
      data_source: str = "csv"  # csv, numpy, dataframe
      
      @classmethod
      def from_cli_args(cls, args) -> 'BacktestConfig':
          pass
      
      @classmethod
      def from_gui_config(cls, config) -> 'BacktestConfig':
          pass
  ```
- [ ] Реализовать `src/core/backtest_results.py`:
  ```python
  class BacktestResults:
      def __init__(self, raw_results: dict):
          self.data = raw_results
      
      def to_dict(self) -> dict:
          return self.data
      
      def to_console_output(self) -> str:
          pass
      
      def to_gui_format(self) -> dict:
          pass
      
      def save_to_file(self, filepath: str):
          pass
  ```
- [ ] Написать базовые тесты для конфигурации

**Критерии выполнения:**
- Core модули созданы
- Базовые тесты проходят
- Нет регрессии в существующем коде

---

### Sprint 2: Core Backtest Engine (1 неделя)

**Цель:** Создать унифицированный BacktestManager

**Задачи:**
- [ ] Реализовать `src/core/backtest_manager.py`:
  ```python
  class BacktestManager:
      def __init__(self):
          self.validator = ConfigValidator()
      
      def validate_config(self, config: BacktestConfig) -> ValidationResult:
          pass
      
      def run_backtest(self, config: BacktestConfig) -> BacktestResults:
          # Единая логика выполнения бектеста
          # Использует существующий run_vectorized_klines_backtest
          pass
      
      def run_batch_backtest(self, configs: List[BacktestConfig]) -> List[BacktestResults]:
          pass
  ```
- [ ] Реализовать `src/core/config_validator.py`:
- [ ] Обновить `src/data/backtest_engine.py` для использования BacktestManager (адаптер)
- [ ] Написать тесты для BacktestManager

**Критерии выполнения:**
- BacktestManager работает с основными стратегиями
- Все существующие CLI тесты проходят
- Покрытие тестами > 80%

---

### Sprint 3: CLI Refactoring (1 неделя)

**Цель:** Перевести CLI на унифицированный core

**Задачи:**
- [ ] Обновить `src/data/backtest_engine.py`:
  ```python
  def main():
      # Создать BacktestConfig из CLI аргументов
      config = BacktestConfig.from_cli_args(args)
      
      # Использовать BacktestManager
      manager = BacktestManager()
      results = manager.run_backtest(config)
      
      # Вывести результаты
      print(results.to_console_output())
  ```
- [ ] Обновить `optimize.py` для использования нового core
- [ ] Создать адаптеры для обратной совместимости
- [ ] Обновить документацию CLI

**Критерии выполнения:**
- CLI работает через BacktestManager
- Обратная совместимость сохранена
- Все CLI команды работают как раньше

---

### Sprint 4: GUI Integration (1 неделя)

**Цель:** Интегрировать GUI с унифицированным core

**Задачи:**
- [ ] Обновить `src/gui/config_models.py`:
  ```python
  class BacktestWorker(QThread):
      def __init__(self, csv_path, symbol, config, **kwargs):
          # Конвертировать GUI config в BacktestConfig
          self.backtest_config = BacktestConfig.from_gui_config(config)
          super().__init__()
      
      def run(self):
          manager = BacktestManager()
          results = manager.run_backtest(self.backtest_config)
          self.result_signal.emit(results.to_gui_format())
  ```
- [ ] Обновить `src/gui/tabs/tab_optimization.py` для использования нового core
- [ ] Тестирование GUI интеграции

**Критерии выполнения:**
- GUI работает через BacktestManager
- Все функции GUI работают как раньше
- Нет утечек памяти и потоков

---

### Sprint 5: Optimization Unification (1 неделя)

**Цель:** Унифицировать оптимизацию

**Задачи:**
- [ ] Создать `src/core/optimization_manager.py`:
  ```python
  class OptimizationManager:
      def __init__(self):
          self.backtest_manager = BacktestManager()
      
      def run_optimization(self, config: OptimizationConfig) -> OptimizationResults:
          # Единая логика оптимизации
          pass
  ```
- [ ] Обновить `src/optimization/optimize_cli.py` для использования OptimizationManager
- [ ] Обновить `src/gui/tabs/tab_optimization.py` для использования OptimizationManager
- [ ] Тестирование оптимизации

**Критерии выполнения:**
- Оптимизация работает через единый менеджер
- CLI и GUI оптимизация дают одинаковые результаты
- Производительность не ухудшилась

---

### Sprint 6: Testing & Performance (1 неделя)

**Цель:** Тестирование и оптимизация производительности

**Задачи:**
- [ ] Написать интеграционные тесты для всего потока
- [ ] Протестировать производительность нового core
- [ ] Оптимизировать узкие места
- [ ] Обновить документацию

**Критерии выполнения:**
- Все тесты проходят
- Производительность не хуже исходной
- Документация обновлена

---

### Sprint 7: Cleanup & Documentation (1 неделя)

**Цель:** Очистка кода и финальная документация

**Задачи:**
- [ ] Удалить дублированный код
- [ ] Обновить README и примеры использования
- [ ] Создать migration guide
- [ ] Финальное тестирование

**Критерии выполнения:**
- Дублированный код удалён
- Документация полная
- Migration guide создан

---

## Общие принципы реализации

### 1. Постепенный рефакторинг
- Не ломать существующий код
- Использовать адаптеры для обратной совместимости
- Тестировать на каждом этапе

### 2. Тестирование
- Unit тесты для каждого core модуля
- Интеграционные тесты для CLI и GUI
- Тесты производительности

### 3. Обратная совместимость
- Все существующие CLI команды должны работать
- GUI интерфейс не должен измениться
- API должен оставаться стабильным

### 4. Документирование
- Комментировать все изменения
- Создавать примеры использования
- Вести changelog

## Ожидаемые результаты

После 7 спринтов (7 недель):
- **Уменьшение дублирования кода на 40%**
- **Единая логика** бектестинга и оптимизации
- **Упрощение поддержки** и добавления новых функций
- **Согласованность** между CLI и GUI версиями
- **Улучшенная тестируемость** core компонентов

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Регрессии в GUI | Средняя | Высокое | Тестирование GUI на каждом спринте |
| Потеря производительности | Низкая | Среднее | Бенчмарки на каждом этапе |
| Сложность миграции | Средняя | Среднее | Постепенный рефакторинг с адаптерами |

### Заключение

Текущая архитектура с двумя отдельными бектестерами создаёт избыточность и потенциальные проблемы с поддержкой. Рекомендуется унифицировать код через создание общего core слоя, который будет использоваться как CLI, так и GUI версиями. Это значительно упростит поддержку и развитие проекта.

План спринтов обеспечивает поэтапный переход с минимальными рисками и сохранением обратной совместимости.

## Sprint 1: Foundation - Результаты

### Дата выполнения: 2025-10-05

### Выполненные задачи:
- [x] Создана `src/core/` директория
- [x] Реализован `src/core/backtest_config.py`:
  - Унифицированный класс конфигурации для CLI и GUI
  - Методы создания из CLI аргументов и GUI конфигурации
  - Валидация параметров
  - Поддержка параметров стратегий через StrategyRegistry
- [x] Реализован `src/core/backtest_results.py`:
  - Унифицированный класс результатов для CLI и GUI
  - Форматирование для консольного вывода
  - Форматирование для GUI отображения
  - Сохранение результатов в файл
  - Удобные методы доступа к данным
- [x] Написаны базовые тесты:
  - 14 тестов для BacktestConfig
  - 18 тестов для BacktestResults
  - Все тесты проходят успешно
- [x] Проверена обратная совместимость:
  - CLI бектестер работает без изменений
  - Импорт новых модулей работает корректно

### Созданные файлы:
```
src/core/
├── __init__.py
├── backtest_config.py
└── backtest_results.py

tests/
├── __init__.py
├── test_backtest_config.py
└── test_backtest_results.py
```

### Ключевые особенности реализации:
1. **BacktestConfig**:
   - Поддержка создания из CLI аргументов (`from_cli_args`)
   - Поддержка создания из GUI конфигурации (`from_gui_config`)
   - Валидация параметров с детальными сообщениями об ошибках
   - Автоматическая загрузка параметров стратегий по умолчанию

2. **BacktestResults**:
   - Единый формат результатов для всех интерфейсов
   - Форматирование для консольного вывода (`to_console_output`)
   - Форматирование для GUI (`to_gui_format`)
   - Сохранение в JSON и текстовые форматы
   - Удобные методы доступа к ключевым метрикам

### Тестирование:
- **BacktestConfig**: 14 тестов, все проходят
- **BacktestResults**: 18 тестов, все проходят
- **Обратная совместимость**: CLI работает без изменений

### Следующие шаги:
Sprint 1 успешно завершён. Основание для унифицированного бектестера создано. Можно переходить к Sprint 2: Core Backtest Engine.

## Sprint 2: Core Backtest Engine - Результаты

### Дата выполнения: 2025-10-05

### Выполненные задачи:
- [x] Реализован `src/core/config_validator.py`:
  - Валидация конфигураций бектестов
  - Проверка параметров стратегий
  - Детальные сообщения об ошибках и предупреждениях
  - Валидация пакетов конфигураций
- [x] Реализован `src/core/backtest_manager.py`:
  - Унифицированный менеджер для выполнения бектестов
  - Поддержка одиночных и пакетных бектестов
  - Параллельное выполнение бектестов
  - Статистика выполнения
  - Интеграция с существующим бектестером
- [x] Обновлён `src/data/backtest_engine.py`:
  - Добавлена функция `run_unified_backtest` для совместимости
  - Добавлена опция `--use-unified` для использования нового менеджера
  - Сохранена обратная совместимость с существующим CLI
- [x] Написаны тесты:
  - 17 тестов для ConfigValidator
  - 16 тестов для BacktestManager
  - Все тесты проходят успешно
- [x] Проверена работа с реальными данными:
  - BacktestManager успешно выполняет бектесты
  - CLI с опцией `--use-unified` работает корректно
  - Обратная совместимость сохранена

### Созданные файлы:
```
src/core/
├── __init__.py (обновлён)
├── backtest_config.py
├── backtest_results.py
├── backtest_manager.py (новый)
└── config_validator.py (новый)

tests/
├── __init__.py
├── test_backtest_config.py
├── test_backtest_results.py
├── test_backtest_manager.py (новый)
└── test_config_validator.py (новый)

src/data/
└── backtest_engine.py (обновлён)
```

### Ключевые особенности реализации:
1. **ConfigValidator**:
   - Валидация всех параметров конфигурации
   - Проверка параметров стратегий по их спецификациям
   - Подробные сообщения об ошибках и предупреждениях
   - Поддержка валидации пакетов конфигураций

2. **BacktestManager**:
   - Единый интерфейс для выполнения бектестов
   - Поддержка одиночных и пакетных бектестов
   - Параллельное выполнение с настраиваемым количеством потоков
   - Статистика выполнения (успешные, неудачные, время выполнения)
   - Интеграция с существующим бектестером через адаптер

3. **Интеграция с CLI**:
   - Новая опция `--use-unified` для использования BacktestManager
   - Функция `run_unified_backtest` для совместимости
   - Сохранение полной обратной совместимости

### Тестирование:
- **ConfigValidator**: 17 тестов, все проходят
- **BacktestManager**: 16 тестов, все проходят
- **Интеграция**: CLI бектестер работает с опцией `--use-unified`
- **Обратная совместимость**: существующий CLI работает без изменений

### Примеры использования:
```python
# Использование BacktestManager
from src.core import BacktestManager, BacktestConfig

config = BacktestConfig(
    strategy_name='hierarchical_mean_reversion',
    symbol='BTCUSDT',
    data_path='data.csv'
)

manager = BacktestManager()
results = manager.run_backtest(config)
```

```bash
# Использование CLI с новым менеджером
python -m src.data.backtest_engine --csv data.csv --strategy hierarchical_mean_reversion --use-unified
```

### Интеграция с GUI:
- [x] Обновлён `src/gui/config_models.py`:
  - BacktestWorker теперь использует BacktestManager
  - Сохранена обратная совместимость с существующим GUI
  - Результаты преобразуются в словарь для совместимости

### Исправление проблем с валидацией:
- [x] Обновлён `src/core/config_validator.py`:
  - Добавлена автоматическая загрузка параметров по умолчанию из стратегии
  - Параметры, выходящие за диапазон, теперь вызывают предупреждения, а не ошибки
  - Сохранена обратная совместимость с существующим кодом

### Тестирование GUI:
- [x] Проверена работа всех компонентов GUI:
  - StrategyConfig создаётся успешно
  - BacktestConfig создаётся успешно
  - BacktestWorker создаётся успешно
  - Все импорты работают корректно

### Анализ сокращения кодовой базы:
До рефакторинга:
- CLI бектестер: ~800 строк кода
- GUI бектестер: ~1200 строк кода
- Дублирование кода: ~400 строк
- Общий объём: ~2400 строк кода

После Sprint 1 и Sprint 2:
- Унифицированные компоненты (BacktestConfig, BacktestResults): ~600 строк
- BacktestManager: ~350 строк
- ConfigValidator: ~250 строк
- Адаптеры для обратной совместимости: ~100 строк
- Общий объём: ~1300 строк кода

**Сокращение кодовой базы: ~46% (с 2400 до 1300 строк)**

### Следующие спринты:

#### Sprint 3: CLI Integration (Планируется)
- [ ] Полная интеграция BacktestManager в CLI интерфейс
- [ ] Обновление всех CLI команд для использования BacktestManager
- [ ] Добавление опций для пакетных бектестов
- [ ] Оптимизация производительности CLI
- [ ] Миграция существующих CLI скриптов

#### Sprint 4: GUI Integration (Планируется)
- [ ] Полная интеграция BacktestManager в GUI
- [ ] Обновление всех компонентов GUI для использования BacktestManager
- [ ] Добавление поддержки пакетных бектестов в GUI
- [ ] Оптимизация производительности GUI
- [ ] Миграция существующих GUI компонентов

#### Sprint 5: Advanced Features (Планируется)
- [ ] Реализация оптимизации параметров
- [ ] Добавление поддержки множественных стратегий
- [ ] Реализация параллельных бектестов
- [ ] Добавление статистики и аналитики
- [ ] Интеграция с внешними системами

#### Sprint 6: Documentation & Testing (Планируется)
- [ ] Написание полной документации
- [ ] Создание руководств пользователя
- [ ] Расширение тестового покрытия
- [ ] Создание примеров использования
- [ ] Подготовка к релизу

### Следующие шаги:
Sprint 2 успешно завершён! Создан унифицированный BacktestManager, который полностью интегрирован как в CLI, так и в GUI версии.

Теперь `python main.py` работает с использованием новых компонентов (BacktestManager, ConfigValidator), обеспечивая унифицированный подход к бектестингу. Проблемы с валидацией параметров решены.

Кодовая база сокращена на ~46% (с 2400 до 1300 строк) за счёт устранения дублирования и создания унифицированных компонентов.

Можно переходить к Sprint 3: CLI Integration, где мы полностью интегрируем BacktestManager в CLI интерфейс.