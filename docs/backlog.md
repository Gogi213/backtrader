# Backlog

## 2025-10-09 - Рефакторинг стратегии в соответствии с `signals.txt`

### Тип: Рефакторинг

### Описание
Полностью переработана `PortedFromExampleStrategy` для приведения в соответствие с официальной документацией `signals.txt`.

### Ключевые изменения:
- **`signal_generators.py`**:
    - Логика генерации сигналов теперь строго соответствует "Этапу 1".
    - Исправлен расчет процентилей (`vol_pctl`, `rng_pctl`).
    - Удалена посторонняя логика фильтрации (`enable_additional_filters`), которая относилась к этапу подтверждения.
- **`ported_from_example_strategy.py`**:
    - Устранен дублирующийся код (удалена старая версия `_build_trades_numba`).
    - Торговый цикл `_build_trades_numba` полностью переписан для соответствия "Этапам 2 и 3".
    - Реализован параметр `entry_logic_mode` для гибкого выбора логики определения направления.
    - Реализованы параметры `hldir_offset` и `aggressive_mode`.
    - Логика входа, выхода, SL/TP приведена к стандартному виду, описанному в `signals.txt`.
    - Обновлены параметры по умолчанию и пространство поиска гиперпараметров.

### Обоснование
Предыдущая реализация содержала дублирование, ошибки в расчетах и значительные отклонения от документированной логики. Рефакторинг устранил эти проблемы, сделав код чистым, предсказуемым и полностью управляемым через параметры, что критически важно для дальнейшей оптимизации и тестирования.

---

## 2025-10-10 - Оптимизация производительности бэктестера

### Тип: Оптимизация

### Описание
В ходе анализа было выявлено, что бэктестер значительно замедлялся при определенных комбинациях параметров, которые генерировали большое количество сделок. Время выполнения одного прогона оптимизации могло достигать 28 секунд.

Проблема была локализована в функции `_vectorized_find_exit` в `ported_from_example_strategy.py`. Эта функция для каждой сделки создавала полные срезы данных от точки входа до конца истории, что приводило к экспоненциальному росту потребления памяти и процессорного времени при увеличении числа сделок.

### Ключевые изменения:
- **`ported_from_example_strategy.py`**:
    - Неэффективная "векторизованная" функция `_vectorized_find_exit` была заменена на новую, итеративную Numba-функцию `_find_exit_optimized`.
    - Новая функция итерируется по свечам после входа и немедленно прекращает работу при нахождении первого условия для выхода (SL, TP или агрессивный выход), что исключает создание больших массивов в памяти.

### Обоснование
Замена алгоритма поиска выхода на итеративный, но скомпилированный с помощью Numba, позволила на порядки ускорить обработку сделок. Это устранило "бутылочное горлышко" в производительности и сделало процесс оптимизации значительно более быстрым и стабильным, независимо от количества генерируемых сделок.

---

## 2025-10-10 - Восстановление функциональности визуализации графиков

### Тип: Исправление ошибки / Новая функция

### Описание
Было обнаружено, что кнопка "Открыть график" в TUI не работала. Анализ показал, что весь модуль визуализации (`src/optimization/visualization.py`) был отключен и содержал только заглушки.

### Ключевые изменения:
- **`src/optimization/visualization.py`**:
    - Файл был полностью переписан для восстановления функциональности.
    - Добавлена зависимость от `plotly`.
    - Реализована функция `plot_candlestick_chart` для создания свечного графика с нанесенными на него сделками (входы long/short и выходы).
    - Реализована функция `plot_and_open`, которая создает HTML-файл с графиком и автоматически открывает его в браузере.
    - Удален неиспользуемый код и заглушки.

### Обоснование
Восстановление визуализации является критически важным для анализа результатов бэктестирования. Новая реализация позволяет пользователям TUI мгновенно получать визуальное представление о работе стратегии с лучшими параметрами, что значительно упрощает анализ и принятие решений.

---

## 2025-10-10 - Исправление ошибки импорта (ImportError)

### Тип: Исправление ошибки

### Описание
После рефакторинга модуля визуализации и удаления неиспользуемого класса `OptimizationVisualizer` приложение перестало запускаться с ошибкой `ImportError`. Причина заключалась в том, что ссылка на удаленный класс осталась в файле `src/optimization/__init__.py`.

### Ключевые изменения:
- **`src/optimization/__init__.py`**:
    - Удален импорт `OptimizationVisualizer` из `src.optimization.visualization`.
    - Удалено имя `OptimizationVisualizer` из списка `__all__`.

### Обоснование
Это исправление было необходимо для восстановления работоспособности приложения после предыдущих изменений. Оно устраняет ошибку, возникшую из-за неполного рефакторинга.

---

## 2025-10-10 - Исправление отображения свечного графика

### Тип: Исправление ошибки

### Описание
После восстановления модуля визуализации было замечено, что свечной график отображался некорректно (как линия, а не как свечи). Причина заключалась в том, что стратегия `PortedFromExampleStrategy` передавала в результаты бэктеста только цены закрытия (`close`), но не `open`, `high` и `low`.

### Ключевые изменения:
- **`src/strategies/ported_from_example_strategy.py`**:
    - В словарь `indicator_data` теперь добавляются полные OHLC-данные (`opens`, `highs`, `lows`).
- **`src/optimization/visualization.py`**:
    - Код построения графика обновлен для явного использования полных OHLC-данных, убраны "костыли" с использованием `prices` в качестве запасного варианта.

### Обоснование
Это исправление обеспечивает корректное отображение свечных графиков, что является базовым требованием для визуального анализа результатов бэктеста.

---

## 2025-10-10 - Расширение целевых функций (Objectives) для Optuna

### Тип: Новая функция

### Описание
Для более гибкой и сбалансированной оптимизации были добавлены новые комплексные целевые функции (objectives), которые учитывают не только доходность с поправкой на риск (Sharpe Ratio), но и другие важные метрики, такие как максимальная просадка, количество сделок и Profit Factor.

### Ключевые изменения:
- **`src/optimization/objectives.py`**:
    - Создан новый модуль для хранения кастомных целевых функций.
    - Реализованы три новые функции:
        1.  `sharpe_with_drawdown_penalty`: Sharpe Ratio с штрафом за максимальную просадку.
        2.  `sharpe_multiplied_by_profit_factor`: Sharpe Ratio, умноженный на логарифм Profit Factor.
        3.  `comprehensive_score`: Комплексный показатель, учитывающий Sharpe, просадку и количество сделок.
- **`src/optimization/fast_optimizer.py`**:
    - Оптимизатор теперь импортирует и использует новые целевые функции из `objectives.py`.
- **`src/tui/optimization_app.py`**:
    - В выпадающий список "Метрика" в TUI добавлены новые целевые функции, что позволяет пользователю легко выбирать их для оптимизации.

### Обоснование
Добавление новых целевых функций позволяет проводить более глубокую и многогранную оптимизацию стратегий. Вместо того чтобы фокусироваться на одной метрике, теперь можно искать баланс между доходностью, риском, эффективностью и статистической значимостью, что приводит к нахождению более робастных и надежных торговых систем.

---

## 2025-10-10 - Добавление новой целевой функции "Sharpe*PF*Trades"

### Тип: Новая функция

### Описание
По запросу была добавлена новая, еще более комплексная целевая функция, которая объединяет в себе три ключевые метрики: Sharpe Ratio (стабильность), Profit Factor (эффективность) и количество сделок (статистическая значимость).

### Ключевые изменения:
- **`src/optimization/objectives.py`**:
    - Добавлена новая функция `sharpe_profit_factor_trades_score`.
    - Формула: `Sharpe * log(1 + Profit Factor) * log(1 + Total Trades)`.
- **`src/tui/optimization_app.py`**:
    - Новая метрика "Sharpe*PF*Trades" добавлена в выпадающий список в TUI.

### Обоснование
Эта новая метрика представляет собой мощный инструмент для поиска наиболее сбалансированных стратегий, которые одновременно являются стабильными, эффективными и подтвержденными достаточным количеством сделок.

---

## 2025-10-10 - Исправление ошибки `NameError` в `objectives.py`

### Тип: Исправление ошибки

### Описание
После добавления новой целевой функции `sharpe_profit_factor_trades_score` приложение перестало запускаться с ошибкой `NameError`. Причина заключалась в том, что функция была определена после ее использования в словаре `OBJECTIVE_FUNCTIONS`.

### Ключевые изменения:
- **`src/optimization/objectives.py`**:
    - Изменен порядок кода: определение функции `sharpe_profit_factor_trades_score` было перемещено перед словарем `OBJECTIVE_FUNCTIONS`.

### Обоснование
Это исправление было необходимо для восстановления работоспособности приложения после добавления новой функции.

---

## 2025-10-10 - Упрощение интерфейса выбора целевой функции

### Тип: Улучшение UX

### Описание
По запросу был упрощен интерфейс выбора целевой функции в TUI. Несмотря на то, что в коде (`src/optimization/objectives.py`) сохраняются все ранее созданные кастомные метрики для будущих экспериментов, в выпадающем списке TUI теперь отображаются только две основные опции.

### Ключевые изменения:
- **`src/tui/optimization_app.py`**:
    - Выпадающий список "Метрика" был сокращен до двух вариантов:
        1.  `Комплексная (Sharpe*PF*Trades)`
        2.  `Чистый Sharpe Ratio`
- **`src/optimization/objectives.py`**:
    - Файл возвращен к состоянию, содержащему все кастомные функции, чтобы не терять наработки.

### Обоснование
Это изменение упрощает пользовательский интерфейс, делая его менее перегруженным и более сфорованным на двух наиболее востребованных метриках, при этом сохраняя гибкость в коде для разработчиков.

---

## 2025-10-10 - Добавлено отображение прогресса оптимизации

### Тип: Улучшение UX

### Описание
Для повышения информативности процесса оптимизации в TUI было добавлено отображение прогресса в реальном времени. Теперь пользователь видит, какой по счету перебор (trial) выполняется из общего запланированного количества.

### Ключевые изменения:
- **`src/optimization/fast_optimizer.py`**:
    - В метод `optimize` добавлен параметр `callbacks`, который позволяет передавать функции, вызываемые Optuna после каждого перебора.
- **`src/tui/optimization_app.py`**:
    - Добавлен новый виджет `Label` для отображения статуса.
    - Реализована `callback`-функция `progress_callback`, которая обновляет текст в этом виджете в формате "Прогресс: X|Y", где X — текущий перебор, а Y — общее количество.
    - Этот `callback` передается в оптимизатор при запуске.

### Обоснование
Это улучшение делает длительный процесс оптимизации более "прозрачным" и понятным для пользователя, позволяя ему отслеживать, на каком этапе находится вычисление.